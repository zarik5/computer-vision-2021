\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[british]{babel}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[margin=1in]{geometry}

\newcommand{\cc}{\fontfamily{txtt}\selectfont}



\begin{document}
\begin{center}
\begin{tabular}{c}
\LARGE{Lab 2}\\
\large{Mattia Giacomello}\\
I.D. 1210988
\end{tabular}
\end{center}

\section{Goal}
The goal is create a script that, from a set of images, extrapolate the chessboard patterned object in every image, calculate the intrinsic parameters and the distortion coefficients of the camera used.
After the computation of these parameters they are used to remap an image, removing the distortions.

\section{Procedure}
The image set used is self taken and is used a chessboard pattern with 7 corners per row, 6 corners per column and squares with edge size of 3 cm.
After loading the images, the program search for the chessboard inner corners in each image through the {\cc findChessboardCorners()} OPENCV method, that gives a vector of 2D points in the image plane.
To calibrate te camera is needed also a 3D reference of the chessboard in the real world, that is created fixing Z=0 and placing the corners on the XY plane with the real measures.
From these 2 set of points, thanks to the {\cc calibrateCamera()} method, we can obtain the intrinsic parameters as the camera matrix and the distortion coefficients. This method computes also the extrinsic parameters for each image.
To reduce the reprojection error is possible to use the {\cc cornerSubPix()} method that increase the accuracy of the corners position for each image through a 11x11 pixels search window. 
This value is chosen after some trial and gives a good result lowering the reprojection error.
If the window is larger the error still lowers but it is a very small change against a large time required.
The other parameters are the recommended ones since no relevant changes are observed modifying them.\newline
The obtained results are reported in the table (\ref{Table:values}). 
Observing the root mean square error is possible to notice that this refinement is useful since there is a relevant change without and with, it is halved in this case.
The image with the worst RMS is blured due to the focus and this make difficult find the corners, but we can observe that thanks the refinement there is a big improvement.
The instrinsic matrices are similar, the most significative change is visible in the third column, the offsets.
The lens distortion coefficients have a more drastic change, as we can see the tangent coefficient $p_1$ even changes sign.\newline
From the computed instrinsic parameters it si possible to undistort and rectify the images throught the {\cc initUndistortRectifyMap()} and {\cc remap()} methods.
In particular, the first one gives us 2 maps, one for x and one for y, that specify where a pixel in the distorted image will be mapped in the undistorted one, while the second one take these matrices and applies the effective mapping, giving us the final image.
Since the image has a low distortion the effect of this remap is not so obvious at first sight.
Looking at the edges of the picture is visible that there is a change since the pixels are stretched, thanks to the radial distortion correction.
Moreover the straight lines in the original image are a bit bent while in the remapped image the desk's edge and the chessboard's lines result more straight and the toy cars have more natural proportions.
In conclusion, the {\cc cornerSubPix()} function is useful to achieve more accuracy after a first, fast, search to improve the precision of the parameters.
Regarding the remapping, even if the distortion coefficients are low, after the undistorted image is  the overall result is better.
\begin{center}
  \begin{table}[ht]
    \centering
    \begin{tabular}{|c | c c|}
      \hline
      & w/o {\cc cornerSubPix()} & w {\cc cornerSubPix()}\\
      \hline
      \hline
      Instrinsic Matrix & 
      $ \begin{bmatrix} 2223& 0& 1499\\
        0& 2222& 970.9\\
        0& 0& 1 \end{bmatrix}$ & 
        $ \begin{bmatrix} 2224& 0& 1496\\
          0& 2222& 966.1\\
          0& 0& 1 \end{bmatrix}$ \\
     \hline
     $\begin{matrix}
     \text{Distortion Coefficients}\\ \begin{bmatrix}k_1\\ k_2\\ k_3\\ p_1\\ p_2 \end{bmatrix} 
     \end{matrix}$ & 
    $\begin{bmatrix}-0.1537\\ 0.2102\\ -0.1691\\ 0.0002\\ 0.0007\end{bmatrix}$ &
     $\begin{bmatrix} -0.1449\\ 0.1558\\ -0.0743\\ -0.0003\\0.0004 \end{bmatrix}$ \\
     \hline
     RMS & 0.8319& 0.4444\\
     \hline
     Best Image &   0.3056 & 0.2313\\
     \hline
     Worst Image &  1.456& 0.9014\\
     \hline
    \end{tabular}    
  \caption{Results of calibration procedure with and without the {\cc cornerSubPix()} method.}
  \label{Table:values}
  \end{table}
  \begin{figure}[ht]
    \includegraphics[width=\linewidth]{Pictures/Original.jpg}
    \caption{The original distorted image}
  \end{figure}  
  \begin{figure}[ht]
    \includegraphics[width=\linewidth]{Pictures/Undistorted.jpg}
    \caption{The undistorted image}
  \end{figure}
  \begin{figure}[ht]
    \includegraphics[width=\linewidth]{Pictures/Worst.jpg}
    \caption{The worst case in the self taken set}
  \end{figure}
\end{center}
\end{document}
